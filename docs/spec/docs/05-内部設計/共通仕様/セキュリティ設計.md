# セキュリティ設計

## 1. セキュリティ方針

### 1.1 基本原則

本プロジェクトでは、以下のセキュリティ原則に基づいて設計・開発する。

1. **最小権限の原則** - 必要最小限の権限のみを付与
2. **多層防御** - 複数のセキュリティレイヤーで保護
3. **デフォルトで安全** - セキュアな設定をデフォルトとする
4. **完全な仲介** - すべてのアクセスをチェック
5. **オープンな設計** - セキュリティを秘密に依存させない

### 1.2 脅威モデル

想定される主な脅威。

- **OWASP Top 10**: Webアプリケーションの一般的な脆弱性
- **認証・認可の不備**: 不正アクセス、権限昇格
- **データ漏洩**: 個人情報、機密情報の流出
- **DDoS攻撃**: サービス拒否攻撃
- **インジェクション攻撃**: SQLインジェクション、XSS等

## 2. セキュリティテスト戦略

### 2.1 SAST (Static Application Security Testing)

**概要:** ソースコードの静的解析によるセキュリティ脆弱性の検出。

**ツール:**

- **CodeQL** - GitHub Code Scanning
- **Biome** - TypeScript/JavaScript静的解析

**実施タイミング:**

- プルリクエスト作成時（自動）
- mainブランチへのマージ時（自動）

**検出対象:**

- ハードコードされたシークレット
- SQLインジェクション、XSSの可能性
- 安全でないAPI使用
- セキュリティ設定の不備

### 2.2 DAST (Dynamic Application Security Testing)

**概要:** 稼働中のアプリケーションに対する動的セキュリティテスト。

**ツール:**

- **OWASP ZAP** - Webアプリケーション脆弱性スキャナ

**実施環境:**

- Staging環境（推奨）
- 開発環境（ローカル）

**スキャンモード:**

#### ベースラインスキャン

- **頻度:** 週次、または重要な機能追加時
- **特徴:** 受動的スキャンのみ、アプリケーションに攻撃しない
- **所要時間:** 数分〜10分程度
- **実行方法:**

  ```bash
  cd infra/dast
  ./run-zap-scan.sh
  ```

#### フルスキャン

- **頻度:** リリース前、セキュリティ監査時
- **特徴:** 能動的攻撃を含む包括的なテスト
- **所要時間:** 30分〜数時間
- **注意:** 本番環境では実行しないこと
- **実行方法:**

  ```bash
  cd infra/dast
  ./run-zap-scan.sh -m full
  ```

**検出対象:**

- XSS（クロスサイトスクリプティング）
- SQLインジェクション
- CSRFトークンの不備
- セキュリティヘッダーの欠落
- SSL/TLS設定の問題
- 認証・セッション管理の脆弱性

**レポート:**

- 出力先: `infra/dast/reports/`
- 形式: HTML、JSON、Markdown、XML
- 保存期間: 最低6ヶ月（監査証跡として）

### 2.3 依存パッケージの脆弱性スキャン

**ツール:**

- **npm audit** - npm公式の脆弱性スキャン
- **Dependabot** - GitHub自動依存関係更新

**実施タイミング:**

- 依存パッケージ追加・更新時
- 定期実行（週次）

## 3. 認証・認可

### 3.1 認証方式

**実装予定:**

- JWT (JSON Web Token) ベースの認証
- Passport.js による認証戦略
- Local戦略（メールアドレス + パスワード）
- OAuth 2.0 / OpenID Connect（将来的に）

**セキュリティ要件:**

- パスワードのハッシュ化（bcrypt、ソルト付き）
- トークンの有効期限管理
- リフレッシュトークンの実装
- CSRF対策

### 3.2 認可モデル

**実装予定:**

- ロールベースアクセス制御（RBAC）
- リソースレベルでの権限チェック

## 4. データ保護

### 4.1 暗号化

**通信の暗号化:**

- HTTPS (TLS 1.2以上) による通信の暗号化
- CloudFront + ACM証明書の使用

**保管データの暗号化:**

- RDS（Aurora PostgreSQL）: 保存時の暗号化有効化
- S3: サーバーサイド暗号化（SSE-S3）
- シークレット: AWS Systems Manager Parameter Store（SecureString）

### 4.2 個人情報保護

- 最小限の個人情報のみ収集
- アクセスログの匿名化
- データ削除ポリシーの実装（GDPR対応）

## 5. ネットワークセキュリティ

### 5.1 インフラストラクチャセキュリティ

**VPC構成:**

- プライベートサブネット: データベース、アプリケーションサーバー
- パブリックサブネット: ALB、Bastion（Staging環境はコスト削減のためパブリック配置）

**セキュリティグループ:**

- 最小権限の原則に基づくルール設定
- ポート単位、IPアドレス単位での制限
- Staging環境: 動的IP検出 + 固定IP許可

**WAF (Web Application Firewall):**

- 本番環境: 有効化（必須）
- Staging環境: 無効化（コスト削減のため）
- ルール:
  - SQLインジェクション対策
  - XSS対策
  - レート制限
  - 地理的ブロッキング（必要に応じて）

### 5.2 DDoS対策

- CloudFront による分散処理
- AWS Shield Standard（自動適用）
- レート制限（API Gateway、WAF）

## 6. セキュアコーディング

### 6.1 入力検証

- **クライアントサイド:** Zod スキーマによるバリデーション
- **サーバーサイド:** Class Validator、Class Transformer
- **原則:** すべての入力を信頼しない

### 6.2 出力エスケープ

- **XSS対策:** React の自動エスケープ機能を活用
- **SQL対策:** Prisma O/Rマッパ によるパラメータ化クエリ
- **コマンドインジェクション対策:** シェルコマンド実行の最小化

### 6.3 エラーハンドリング

- 本番環境: スタックトレースを表示しない
- エラーログ: 機密情報を含めない
- ユーザーへのエラーメッセージ: 最小限の情報のみ

## 7. ロギング・モニタリング

### 7.1 セキュリティログ

**記録対象:**

- 認証イベント（成功・失敗）
- 認可エラー
- 入力検証エラー
- API呼び出し（レート制限超過等）

**ログ保管:**

- MongoDB Atlas（集中ログ管理）
- CloudWatch Logs
- 保存期間: 最低6ヶ月

### 7.2 監視・アラート

**監視ツール:**

- **Datadog** - APM、インフラ監視
- **Sentry** - エラー追跡、パフォーマンス監視

**アラート条件:**

- 認証失敗の急増
- 異常なAPIアクセスパターン
- セキュリティグループルールの変更
- 高リスク脆弱性の検出（DAST/SAST）

## 8. インシデント対応

### 8.1 インシデント対応フロー

1. **検知** - モニタリングツールによる自動検知
2. **初動対応** - 影響範囲の特定、緊急措置
3. **封じ込め** - 被害拡大の防止
4. **根本原因分析** - ログ分析、脆弱性特定
5. **復旧** - システムの正常化
6. **事後対応** - 再発防止策の実施、ドキュメント更新

### 8.2 連絡体制

- インシデント報告先: プロジェクトオーナー
- エスカレーション基準: 個人情報漏洩、サービス停止等

## 9. セキュリティチェックリスト

### 9.1 開発時

- [ ] 入力検証の実装
- [ ] 出力エスケープの実装
- [ ] 認証・認可の実装
- [ ] セキュアなセッション管理
- [ ] エラーハンドリングの適切な実装
- [ ] 機密情報のハードコード禁止
- [ ] SASTツールでの事前チェック

### 9.2 リリース前

- [ ] DASTテストの実施（ベースライン + フル）
- [ ] 依存パッケージの脆弱性スキャン
- [ ] セキュリティヘッダーの設定確認
- [ ] SSL/TLS証明書の有効性確認
- [ ] WAF設定の確認（本番環境）
- [ ] アクセス制御の確認
- [ ] ログ設定の確認

### 9.3 運用時

- [ ] 定期的なDASTスキャン（週次）
- [ ] 依存パッケージの定期更新
- [ ] セキュリティログの定期確認
- [ ] インシデント対応訓練（四半期ごと）
- [ ] セキュリティパッチの適用

## 10. 参考資料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP Application Security Verification Standard (ASVS)](https://owasp.org/www-project-application-security-verification-standard/)
- [OWASP ZAP Documentation](https://www.zaproxy.org/docs/)
- [AWS セキュリティベストプラクティス](https://aws.amazon.com/jp/architecture/security-identity-compliance/)
- [NestJS Security](https://docs.nestjs.com/security/authentication)
- [Next.js Security Headers](https://nextjs.org/docs/advanced-features/security-headers)

## 11. 更新履歴

| 日付       | 版数 | 更新内容           | 更新者      |
| ---------- | ---- | ------------------ | ----------- |
| 2025-11-13 | 1.0  | 初版作成、DAST導入 | Claude Code |
